
const mongoose = require('mongoose');
const http = require('http')
const cheerio = require('cheerio')
let baseUrl = 'http://kaijiang.500.com/shtml/ssq/'

mongoose.connect('mongodb://localhost/numbers');

var db = mongoose.connection;
db.on('error', console.error.bind(console, 'connection error:'));
db.once('open', function (callback) {
  console.log('open MongoDB')
  // yay!
});
var impressionSchema = mongoose.Schema({
  stage: { type: String },
  red: { type: Array },
  blue: { type: String }

});
var impressionModel = mongoose.model('numbers', impressionSchema);
let stageStr ='18078,18077,18076,18075,18074,18073,18072,18071,18070,18069,18068,18067,18066,18065,18064,18063,18062,18061,18060,18059,18058,18057,18056,18055,18054,18053,18052,18051,18050,18049,18048,18047,18046,18045,18044,18043,18042,18041,18040,18039,18038,18037,18036,18035,18034,18033,18032,18031,18030,18029,18028,18027,18026,18025,18024,18023,18022,18021,18020,18019,18018,18017,18016,18015,18014,18013,18012,18011,18010,18009,18008,18007,18006,18005,18004,18003,18002,18001,17154,17153,17152,17151,17150,17149,17148,17147,17146,17145,17144,17143,17142,17141,17140,17139,17138,17137,17136,17135,17134,17133,17132,17131,17130,17129,17128,17127,17126,17125,17124,17123,17122,17121,17120,17119,17118,17117,17116,17115,17114,17113,17112,17111,17110,17109,17108,17107,17106,17105,17104,17103,17102,17101,17100,17099,17098,17097,17096,17095,17094,17093,17092,17091,17090,17089,17088,17087,17086,17085,17084,17083,17082,17081,17080,17079,17078,17077,17076,17075,17074,17073,17072,17071,17070,17069,17068,17067,17066,17065,17064,17063,17062,17061,17060,17059,17058,17057,17056,17055,17054,17053,17052,17051,17050,17049,17048,17047,17046,17045,17044,17043,17042,17041,17040,17039,17038,17037,17036,17035,17034,17033,17032,17031,17030,17029,17028,17027,17026,17025,17024,17023,17022,17021,17020,17019,17018,17017,17016,17015,17014,17013,17012,17011,17010,17009,17008,17007,17006,17005,17004,17003,17002,17001,16153,16152,16151,16150,16149,16148,16147,16146,16145,16144,16143,16142,16141,16140,16139,16138,16137,16136,16135,16134,16133,16132,16131,16130,16129,16128,16127,16126,16125,16124,16123,16122,16121,16120,16119,16118,16117,16116,16115,16114,16113,16112,16111,16110,16109,16108,16107,16106,16105,16104,16103,16102,16101,16100,16099,16098,16097,16096,16095,16094,16093,16092,16091,16090,16089,16088,16087,16086,16085,16084,16083,16082,16081,16080,16079,16078,16077,16076,16075,16074,16073,16072,16071,16070,16069,16068,16067,16066,16065,16064,16063,16062,16061,16060,16059,16058,16057,16056,16055,16054,16053,16052,16051,16050,16049,16048,16047,16046,16045,16044,16043,16042,16041,16040,16039,16038,16037,16036,16035,16034,16033,16032,16031,16030,16029,16028,16027,16026,16025,16024,16023,16022,16021,16020,16019,16018,16017,16016,16015,16014,16013,16012,16011,16010,16009,16008,16007,16006,16005,16004,16003,16002,16001,15154,15153,15152,15151,15150,15149,15148,15147,15146,15145,15144,15143,15142,15141,15140,15139,15138,15137,15136,15135,15134,15133,15132,15131,15130,15129,15128,15127,15126,15125,15124,15123,15122,15121,15120,15119,15118,15117,15116,15115,15114,15113,15112,15111,15110,15109,15108,15107,15106,15105,15104,15103,15102,15101,15100,15099,15098,15097,15096,15095,15094,15093,15092,15091,15090,15089,15088,15087,15086,15085,15084,15083,15082,15081,15080,15079,15078,15077,15076,15075,15074,15073,15072,15071,15070,15069,15068,15067,15066,15065,15064,15063,15062,15061,15060,15059,15058,15057,15056,15055,15054,15053,15052,15051,15050,15049,15048,15047,15046,15045,15044,15043,15042,15041,15040,15039,15038,15037,15036,15035,15034,15033,15032,15031,15030,15029,15028,15027,15026,15025,15024,15023,15022,15021,15020,15019,15018,15017,15016,15015,15014,15013,15012,15011,15010,15009,15008,15007,15006,15005,15004,15003,15002,15001,14152,14151,14150,14149,14148,14147,14146,14145,14144,14143,14142,14141,14140,14139,14138,14137,14136,14135,14134,14133,14132,14131,14130,14129,14128,14127,14126,14125,14124,14123,14122,14121,14120,14119,14118,14117,14116,14115,14114,14113,14112,14111,14110,14109,14108,14107,14106,14105,14104,14103,14102,14101,14100,14099,14098,14097,14096,14095,14094,14093,14092,14091,14090,14089,14088,14087,14086,14085,14084,14083,14082,14081,14080,14079,14078,14077,14076,14075,14074,14073,14072,14071,14070,14069,14068,14067,14066,14065,14064,14063,14062,14061,14060,14059,14058,14057,14056,14055,14054,14053,14052,14051,14050,14049,14048,14047,14046,14045,14044,14043,14042,14041,14040,14039,14038,14037,14036,14035,14034,14033,14032,14031,14030,14029,14028,14027,14026,14025,14024,14023,14022,14021,14020,14019,14018,14017,14016,14015,14014,14013,14012,14011,14010,14009,14008,14007,14006,14005,14004,14003,14002,14001,13154,13153,13152,13151,13150,13149,13148,13147,13146,13145,13144,13143,13142,13141,13140,13139,13138,13137,13136,13135,13134,13133,13132,13131,13130,13129,13128,13127,13126,13125,13124,13123,13122,13121,13120,13119,13118,13117,13116,13115,13114,13113,13112,13111,13110,13109,13108,13107,13106,13105,13104,13103,13102,13101,13100,13099,13098,13097,13096,13095,13094,13093,13092,13091,13090,13089,13088,13087,13086,13085,13084,13083,13082,13081,13080,13079,13078,13077,13076,13075,13074,13073,13072,13071,13070,13069,13068,13067,13066,13065,13064,13063,13062,13061,13060,13059,13058,13057,13056,13055,13054,13053,13052,13051,13050,13049,13048,13047,13046,13045,13044,13043,13042,13041,13040,13039,13038,13037,13036,13035,13034,13033,13032,13031,13030,13029,13028,13027,13026,13025,13024,13023,13022,13021,13020,13019,13018,13017,13016,13015,13014,13013,13012,13011,13010,13009,13008,13007,13006,13005,13004,13003,13002,13001,12154,12153,12152,12151,12150,12149,12148,12147,12146,12145,12144,12143,12142,12141,12140,12139,12138,12137,12136,12135,12134,12133,12132,12131,12130,12129,12128,12127,12126,12125,12124,12123,12122,12121,12120,12119,12118,12117,12116,12115,12114,12113,12112,12111,12110,12109,12108,12107,12106,12105,12104,12103,12102,12101,12100,12099,12098,12097,12096,12095,12094,12093,12092,12091,12090,12089,12088,12087,12086,12085,12084,12083,12082,12081,12080,12079,12078,12077,12076,12075,12074,12073,12072,12071,12070,12069,12068,12067,12066,12065,12064,12063,12062,12061,12060,12059,12058,12057,12056,12055,12054,12053,12052,12051,12050,12049,12048,12047,12046,12045,12044,12043,12042,12041,12040,12039,12038,12037,12036,12035,12034,12033,12032,12031,12030,12029,12028,12027,12026,12025,12024,12023,12022,12021,12020,12019,12018,12017,12016,12015,12014,12013,12012,12011,12010,12009,12008,12007,12006,12005,12004,12003,12002,12001,11153,11152,11151,11150,11149,11148,11147,11146,11145,11144,11143,11142,11141,11140,11139,11138,11137,11136,11135,11134,11133,11132,11131,11130,11129,11128,11127,11126,11125,11124,11123,11122,11121,11120,11119,11118,11117,11116,11115,11114,11113,11112,11111,11110,11109,11108,11107,11106,11105,11104,11103,11102,11101,11100,11099,11098,11097,11096,11095,11094,11093,11092,11091,11090,11089,11088,11087,11086,11085,11084,11083,11082,11081,11080,11079,11078,11077,11076,11075,11074,11073,11072,11071,11070,11069,11068,11067,11066,11065,11064,11063,11062,11061,11060,11059,11058,11057,11056,11055,11054,11053,11052,11051,11050,11049,11048,11047,11046,11045,11044,11043,11042,11041,11040,11039,11038,11037,11036,11035,11034,11033,11032,11031,11030,11029,11028,11027,11026,11025,11024,11023,11022,11021,11020,11019,11018,11017,11016,11015,11014,11013,11012,11011,11010,11009,11008,11007,11006,11005,11004,11003,11002,11001,10153,10152,10151,10150,10149,10148,10147,10146,10145,10144,10143,10142,10141,10140,10139,10138,10137,10136,10135,10134,10133,10132,10131,10130,10129,10128,10127,10126,10125,10124,10123,10122,10121,10120,10119,10118,10117,10116,10115,10114,10113,10112,10111,10110,10109,10108,10107,10106,10105,10104,10103,10102,10101,10100,10099,10098,10097,10096,10095,10094,10093,10092,10091,10090,10089,10088,10087,10086,10085,10084,10083,10082,10081,10080,10079,10078,10077,10076,10075,10074,10073,10072,10071,10070,10069,10068,10067,10066,10065,10064,10063,10062,10061,10060,10059,10058,10057,10056,10055,10054,10053,10052,10051,10050,10049,10048,10047,10046,10045,10044,10043,10042,10041,10040,10039,10038,10037,10036,10035,10034,10033,10032,10031,10030,10029,10028,10027,10026,10025,10024,10023,10022,10021,10020,10019,10018,10017,10016,10015,10014,10013,10012,10011,10010,10009,10008,10007,10006,10005,10004,10003,10002,10001,09154,09153,09152,09151,09150,09149,09148,09147,09146,09145,09144,09143,09142,09141,09140,09139,09138,09137,09136,09135,09134,09133,09132,09131,09130,09129,09128,09127,09126,09125,09124,09123,09122,09121,09120,09119,09118,09117,09116,09115,09114,09113,09112,09111,09110,09109,09108,09107,09106,09105,09104,09103,09102,09101,09100,09099,09098,09097,09096,09095,09094,09093,09092,09091,09090,09089,09088,09087,09086,09085,09084,09083,09082,09081,09080,09079,09078,09077,09076,09075,09074,09073,09072,09071,09070,09069,09068,09067,09066,09065,09064,09063,09062,09061,09060,09059,09058,09057,09056,09055,09054,09053,09052,09051,09050,09049,09048,09047,09046,09045,09044,09043,09042,09041,09040,09039,09038,09037,09036,09035,09034,09033,09032,09031,09030,09029,09028,09027,09026,09025,09024,09023,09022,09021,09020,09019,09018,09017,09016,09015,09014,09013,09012,09011,09010,09009,09008,09007,09006,09005,09004,09003,09002,09001,08154,08153,08152,08151,08150,08149,08148,08147,08146,08145,08144,08143,08142,08141,08140,08139,08138,08137,08136,08135,08134,08133,08132,08131,08130,08129,08128,08127,08126,08125,08124,08123,08122,08121,08120,08119,08118,08117,08116,08115,08114,08113,08112,08111,08110,08109,08108,08107,08106,08105,08104,08103,08102,08101,08100,08099,08098,08097,08096,08095,08094,08093,08092,08091,08090,08089,08088,08087,08086,08085,08084,08083,08082,08081,08080,08079,08078,08077,08076,08075,08074,08073,08072,08071,08070,08069,08068,08067,08066,08065,08064,08063,08062,08061,08060,08059,08058,08057,08056,08055,08054,08053,08052,08051,08050,08049,08048,08047,08046,08045,08044,08043,08042,08041,08040,08039,08038,08037,08036,08035,08034,08033,08032,08031,08030,08029,08028,08027,08026,08025,08024,08023,08022,08021,08020,08019,08018,08017,08016,08015,08014,08013,08012,08011,08010,08009,08008,08007,08006,08005,08004,08003,08002,08001,07153,07152,07151,07150,07149,07148,07147,07146,07145,07144,07143,07142,07141,07140,07139,07138,07137,07136,07135,07134,07133,07132,07131,07130,07129,07128,07127,07126,07125,07124,07123,07122,07121,07120,07119,07118,07117,07116,07115,07114,07113,07112,07111,07110,07109,07108,07107,07106,07105,07104,07103,07102,07101,07100,07099,07098,07097,07096,07095,07094,07093,07092,07091,07090,07089,07088,07087,07086,07085,07084,07083,07082,07081,07080,07079,07078,07077,07076,07075,07074,07073,07072,07071,07070,07069,07068,07067,07066,07065,07064,07063,07062,07061,07060,07059,07058,07057,07056,07055,07054,07053,07052,07051,07050,07049,07048,07047,07046,07045,07044,07043,07042,07041,07040,07039,07038,07037,07036,07035,07034,07033,07032,07031,07030,07029,07028,07027,07026,07025,07024,07023,07022,07021,07020,07019,07018,07017,07016,07015,07014,07013,07012,07011,07010,07009,07008,07007,07006,07005,07004,07003,07002,07001,06154,06153,06152,06151,06150,06149,06148,06147,06146,06145,06144,06143,06142,06141,06140,06139,06138,06137,06136,06135,06134,06133,06132,06131,06130,06129,06128,06127,06126,06125,06124,06123,06122,06121,06120,06119,06118,06117,06116,06115,06114,06113,06112,06111,06110,06109,06108,06107,06106,06105,06104,06103,06102,06101,06100,06099,06098,06097,06096,06095,06094,06093,06092,06091,06090,06089,06088,06087,06086,06085,06084,06083,06082,06081,06080,06079,06078,06077,06076,06075,06074,06073,06072,06071,06070,06069,06068,06067,06066,06065,06064,06063,06062,06061,06060,06059,06058,06057,06056,06055,06054,06053,06052,06051,06050,06049,06048,06047,06046,06045,06044,06043,06042,06041,06040,06039,06038,06037,06036,06035,06034,06033,06032,06031,06030,06029,06028,06027,06026,06025,06024,06023,06022,06021,06020,06019,06018,06017,06016,06015,06014,06013,06012,06011,06010,06009,06008,06007,06006,06005,06004,06003,06002,06001,05153,05152,05151,05150,05149,05148,05147,05146,05145,05144,05143,05142,05141,05140,05139,05138,05137,05136,05135,05134,05133,05132,05131,05130,05129,05128,05127,05126,05125,05124,05123,05122,05121,05120,05119,05118,05117,05116,05115,05114,05113,05112,05111,05110,05109,05108,05107,05106,05105,05104,05103,05102,05101,05100,05099,05098,05097,05096,05095,05094,05093,05092,05091,05090,05089,05088,05087,05086,05085,05084,05083,05082,05081,05080,05079,05078,05077,05076,05075,05074,05073,05072,05071,05070,05069,05068,05067,05066,05065,05064,05063,05062,05061,05060,05059,05058,05057,05056,05055,05054,05053,05052,05051,05050,05049,05048,05047,05046,05045,05044,05043,05042,05041,05040,05039,05038,05037,05036,05035,05034,05033,05032,05031,05030,05029,05028,05027,05026,05025,05024,05023,05022,05021,05020,05019,05018,05017,05016,05015,05014,05013,05012,05011,05010,05009,05008,05007,05006,05005,05004,05003,05002,05001,04122,04121,04120,04119,04118,04117,04116,04115,04114,04113,04112,04111,04110,04109,04108,04107,04106,04105,04104,04103,04102,04101,04100,04099,04098,04097,04096,04095,04094,04093,04092,04091,04090,04089,04088,04087,04086,04085,04084,04083,04082,04081,04080,04079,04078,04077,04076,04075,04074,04073,04072,04071,04070,04069,04068,04067,04066,04065,04064,04063,04062,04061,04060,04059,04058,04057,04056,04055,04054,04053,04052,04051,04050,04049,04048,04047,04046,04045,04044,04043,04042,04041,04040,04039,04038,04037,04036,04035,04034,04033,04032,04031,04030,04029,04028,04027,04026,04025,04024,04023,04022,04021,04020,04019,04018,04017,04016,04015,04014,04013,04012,04011,04010,04009,04008,04007,04006,04005,04004,04003,04002,04001,03089,03088,03087,03086,03085,03084,03083,03082,03081,03080,03079,03078,03077,03076,03075,03074,03073,03072,03071,03070,03069,03068,03067,03066,03065,03064,03063,03062,03061,03060,03059,03058,03057,03056,03055,03054,03053,03052,03051,03050,03049,03048,03047,03046,03045,03044,03043,03042,03041,03040,03039,03038,03037,03036,03035,03034,03033,03032,03031,03030,03029,03028,03027,03026,03025,03024,03023,03022,03021,03020,03019,03018,03017,03016,03015,03014,03013,03012,03011,03010,03009,03008,03007,03006,03005,03004,03003,03002,03001'
let stageArr = stageStr.split(',')
let idx = 0
function filterChapters(html, stage) {
  let $ = cheerio.load(html)
  let chapters = $('.ball_box01 li')
  let red = [], blue = 0
  for (let i = 0; i < 7; i++) {
    if (i == 6) {
      blue = $(chapters[i]).text()
    } else {
      red.push($(chapters[i]).text())
    }
  }
  console.log(red)
  console.log(blue)
  impressionModel.create([
    {
      stage,
      red,
      blue
    }
  ], (err, doc) => {
    if (err) {
      console.error(err);
    } else {
      if(idx<=stageArr.length){
        idx +=1
        saveDate(idx)
      }
    }
  })
}
function getPageAsync(idx) {
  console.log(`正在爬第${idx+1}条记录`)
  return new Promise((resolve,reject)=>{
    let url = `${baseUrl}${stageArr[idx]}.shtml`
    http.get(url, (res) => {
      let html = ''
      res.on('data', (data) => {
        html += data
      })
      res.on('end', () => {
        resolve(html)
      })
    }).on('error', (e) => {
      console.log('opps!!!')
    })
  })
}
// getPageAsync(0)

async function saveDate(idx){
   let html = await getPageAsync(idx);
   let stage = stageArr[idx]
   filterChapters(html,stage)
 }
 saveDate(idx)
// let promiseArr= []
// let idxArr = ['03001','03002']
// idxArr.forEach(id => {
//   promiseArr.push(getPageAsync(`${baseUrl}${id}.shtml`))
// });

// Promise.all(promiseArr).then((res)=>{
//   let numArr=[]
//   res.forEach(item=>{
//     let nums = filterChapters(item)
//     numArr.push(nums)
//   })
//   console.log(numArr)
// })
